/**
 * IPS Social Suite 4
 * (c) 2013 Invision Power Services - http://www.invisionpower.com
 * This file contains minified javascript and is not directly editable
 */

;(function($,_,undefined){"use strict";ips.controller.register('core.front.search.date',{initialize:function(){this.on('click','[data-action="ok"]',this.ok);},ok:function(e){var type=this.scope.attr('data-dateType');var start=this.scope.find('[data-role="start"]').val();var end=this.scope.find('[data-role="end"]').val();this.trigger('chosenDate.search',{type:type.replace('Custom',''),start:start,end:end});this.trigger('closeMenu');}});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('core.front.search.main',{_currentType:'',_sidebar:null,_content:null,_formData:[],_baseURL:'',initialize:function(){this.on('itemClicked.sideMenu','#elSearch_appFilter',this.switchToAppViewFromSidebar);this.on('click','[data-action="switchToAppView"]',this.switchToAppViewFromMulti);this.on('paginationClicked paginationJump',this.paginationClicked);this.on('keyup','#elInput_tags',this.keyUpTags);this.on('keypress','#elInput_q',this.inputChanged);this.on('tokenDeleted tokenAdded',this.inputChanged);this.on('itemClicked.sideMenu',this.inputChanged);this.on('itemClicked.sideMenu',this.sideMenuChanged);this.on('change',':input',this.inputChanged);this.on('inputChanged',this.inputChanged);this.on('nodeItemSelected',this.inputChanged);this.on('chosenDate.search',this.chosenDate);this.on('submit',this.submitForm);History.Adapter.bind(window,'statechange',_.bind(this.stateChange,this));this.setup();},setup:function(){this._sidebar=this.scope.find('#elSearch_sidebar');this._content=this.scope.find('#elSearch_main');this._updateCurrentType(this.scope.find('#elSearch_appFilter .ipsSideMenu_item.ipsSideMenu_itemActive').attr('data-ipsMenuValue'));this._formData=this._getInitialData();this._baseURL=this.scope.attr('data-baseURL');if(this._baseURL.match(/\?/)){this._baseURL+='&';}else{this._baseURL+='?';}},paginationClicked:function(e,data){if(data.originalEvent){data.originalEvent.preventDefault();}
var done=false;if(!_.isUndefined(this._formData)){for(var i=0;i<this._formData.length;i++){if(this._formData[i]&&this._formData[i].name=='page'){this._formData[i].value=data.pageNo;done=true;}}
if(!done){this._formData.push({name:'page',value:data.pageNo});}}
var formData=this._formData;var url=this._getUrlFromData(formData);History.pushState({controller:'core.front.search.main',app:this._currentType,fromMulti:true,url:url},document.title,url);var elemPosition=ips.utils.position.getElemPosition(this.scope);$('html, body').animate({scrollTop:elemPosition.absPos.top+'px'});},sideMenuChanged:function(e,data){var dateMenus=['elCustomDateChoices_startDate_sideMenu','elCustomDateChoices_updatedDate_sideMenu'];if(_.indexOf(dateMenus,data.id)===-1||data.selectedItemID=='custom'){return;}
data.menuElem.find('[data-ipsMenuValue="custom"]').addClass('ipsJS_hide');var type=data.id.replace('elCustomDateChoices_','').replace('_sideMenu','');this.scope.find('#elCustomDate_'+type+'Custom_menu input[type="date"]').val('');},chosenDate:function(e,data){var sideMenu=this.scope.find('#elCustomDateChoices_'+data.type).find('[data-ipsSideMenu]');sideMenu.trigger('selectItem.sideMenu',{value:'custom'});var dateText='';if(data.start&&data.end){dateText=ips.getString('betweenXandX',{start:data.start,end:data.end});}else if(data.start){dateText=ips.getString('afterX',{start:data.start});}else if(data.end){dateText=ips.getString('beforeX',{end:data.end});}
var customItem=sideMenu.find('[data-ipsMenuValue="custom"]');customItem.removeClass('ipsJS_hide');if(dateText){customItem.find('[data-role="datePreview"]').text(dateText).show();}},inputChanged:function(){this.scope.find('#elSearchButton').prop('disabled',false);},submitForm:function(e){e.preventDefault();var data=this._getFormData();var url=this._getUrlFromData(data);this._formData=data;this.trigger('switchTo.filterBar',{switchTo:'filterContent'});Debug.log(url);History.pushState({controller:'core.front.search.main',app:this._currentType,fromMulti:true,url:url,filterData:this._formData},this._getBrowserTitle(),url);},keyUpTags:function(e){if($(e.currentTarget).val()&&!$('#elRadio_eitherTermsOrTags').is(':visible')){ips.utils.anim.go('fadeIn',$('#elRadio_eitherTermsOrTags'));}else if(!$(e.currentTarget).val()&&$('#elRadio_eitherTermsOrTags').is(':visible')){$('#elRadio_eitherTermsOrTags').hide()}},switchToAppViewFromSidebar:function(e,data){var url=this.scope.find('#elSearch_appFilter [data-ipsMenuValue="'+data.selectedItemID+'"] a').attr('href');var self=this;this._updateCurrentType(data.selectedItemID);var data=this._formData;var url=this._getUrlFromData(data);this.trigger('switchTo.filterBar',{switchTo:'filterContent'});History.pushState({controller:'core.front.search.main',app:this._currentType,fromMulti:true,url:url,filterData:data},this._getBrowserTitle(),url);},switchToAppViewFromMulti:function(e){var url=$(e.currentTarget).attr('href');var self=this;this._updateCurrentType($(e.currentTarget).attr('data-type'));History.pushState({controller:'core.front.search.main',app:this._currentType,fromMulti:true,url:url},this._getBrowserTitle(),url);},stateChange:function(){var state=History.getState();if(!state.data.controller||state.data.controller!='core.front.search.main'){return;}
if(state.data.app){this.scope.find('#elSearch_appFilter .ipsSideMenu_itemActive:not( [data-ipsMenuValue="'+state.data.app+'"] )').removeClass('ipsSideMenu_itemActive');this.scope.find('#elSearch_appFilter .ipsSideMenu_item[data-ipsMenuValue="'+state.data.app+'"]').addClass('ipsSideMenu_itemActive');}
this._loadResults(state.data.url,state.data.fromMulti||false);},_updateCurrentType:function(newType){this._currentType=newType;var done=false;if(!_.isUndefined(this._formData)){for(var i=0;i<this._formData.length;i++){if(this._formData[i]){if(this._formData[i].name=='type'){this._formData[i].value=this._currentType;done=true;}
if(this._formData[i].name=='page'){this._formData.splice(i,1);}}}
if(!done){this._formData.push({name:'type',value:this._currentType});}}},_getUrlFromData:function(data){var url=this._baseURL;if(url.slice(-1)=='&'){url=url.slice(0,-1)}
var i;var haveTerm=false;var haveTags=false;for(i in data){if(data[i].name==='q'&&data[i].value){url+='&q='+encodeURIComponent(data[i].value);}
else if(data[i].name==='tags'&&data[i].value){url+='&tags='+encodeURIComponent(data[i].value);}
else if(data[i].name==='eitherTermsOrTags'){if(haveTerm&&haveTags){url+='&eitherTermsOrTags='+encodeURIComponent(data[i].value);}}
else if(data[i].name==='type'&&data[i].value){url+='&type='+encodeURIComponent(data[i].value);}
else if(data[i].name==='author'&&data[i].value){url+='&author='+encodeURIComponent(data[i].value);}
else if(data[i].name==='startDate'||data[i].name==='updatedDate'){if(data[i].value!='any'&&data[i].value!='custom'){if(data[i].name==='startDate'){url+='&start_after='+encodeURIComponent(data[i].value);}else{url+='&updated_after='+encodeURIComponent(data[i].value);}}}
else if(data[i].name==='startDateCustom[start]'){url+='&start_after='+encodeURIComponent(new Date(data[i].value).getTime()/1000);}
else if(data[i].name==='startDateCustom[end]'){url+='&start_before='+encodeURIComponent(new Date(data[i].value).getTime()/1000);}
else if(data[i].name==='updatedDateCustom[start]'){url+='&updated_after='+encodeURIComponent(new Date(data[i].value).getTime()/1000);}
else if(data[i].name==='updatedDateCustom[end]'){url+='&updated_before='+encodeURIComponent(new Date(data[i].value).getTime()/1000);}
else if(data[i].name==='page'&&data[i].value){url+='&page='+encodeURIComponent(data[i].value);}
else if(data[i].value&&data[i].value!=0&&data[i].name!='form_submitted'&&data[i].name!='csrfKey'&&data[i].name!='radio_eitherTermsOrTags__empty')
{url+='&'+data[i].name+'='+encodeURIComponent(data[i].value);}}
url=url.replace('?&','?');return url;},_getInitialData:function(){var url=this.scope.find('#elSearch_appFilter .ipsSideMenu_itemActive a').attr('href');url=ips.utils.url.getURIObject(url);var data=[];_.each(url.queryKey,function(val,key){if(key.startsWith('/')){return;}
data.push({name:key,value:val});});Debug.log(data);return data;},_getFormData:function(){var serial=this.scope.find('#elSearch_sidebar form').serializeArray();var data=[];var skipData=['sortby','sortDirection','page'];data.push({name:'type',value:this._currentType});for(var i=0;i<serial.length;i++){if(_.indexOf(skipData,serial[i].name)===-1&&serial[i].value!==''){data.push({name:serial[i].name,value:serial[i].value});}}
return data;},_loadResults:function(url,showFiltersLoading){var self=this;if(showFiltersLoading){this._setFilterLoading(true);}
this._setContentLoading(true);ips.getAjax()(url).done(function(response){if(typeof response!=='object'){window.location=url;}
if(response.css){self._addCSS(response.css);}
self._sidebar.find('[data-role="searchFilters"]').html(response.filters);self._content.html(response.content);self._setContentLoading(false);$(document).trigger('contentChange',[self._sidebar]);$(document).trigger('contentChange',[self._content]);}).fail(function(jqXHR,textStatus){window.location=url;}).always(function(){self._setFilterLoading(false);self._setContentLoading(false);});},_addCSS:function(css){var head=$('head');if(css&&css.length){for(var i=0;i<css.length;i++){head.append($('<link/>').attr('href',css[i]).attr('type','text/css').attr('rel','stylesheet'));}}},_setContentLoading:function(state){var results=this.scope.find('[data-role="resultsArea"]');if(state){results.css({height:results.height()+'px'}).html('').append($('<div/>').addClass('ipsLoading').css({'height':'200px'}));}else{results.css({height:'auto'});ips.utils.anim.go('fadeIn fast',results);}},_setFilterLoading:function(state){if(state){this._sidebar.css({pointerEvents:'none'}).animate({opacity:0.6});}else{this._sidebar.css({pointerEvents:'auto',opacity:1});}},_getBrowserTitle:function(){var title=ips.getString('searchTitle');var q='';for(var i=0;i<this._formData.length;i++){if(this._formData[i].name=='q'){q=this._formData[i].value;}}
if(q!==''&&this._currentType==''){title=ips.getString('searchTitleTerm',{term:q});}else if(q!==''&&this._currentType!==''){title=ips.getString('searchTitleTermType',{term:q,type:$('#elSearch_appFilter').find('[data-ipsMenuValue="'+this._currentType+'"] > a').text()});}else if(q===''&&this._currentType!==''){title=ips.getString('searchTitleType',{type:$('#elSearch_appFilter').find('[data-ipsMenuValue="'+this._currentType+'"] > a').text()});}
return title;}});}(jQuery,_));;
;(function($,_,undefined){"use strict";ips.controller.register('core.front.search.results',{initialize:function(){this.setup();this.on(document,'contentChange',_.bind(this.contentChange,this));},setup:function(){jQuery.expr[':'].icontains=function(a,i,m){return jQuery(a).text().toUpperCase().indexOf(m[3].toUpperCase())>=0;};this._highlight(this.scope.attr('data-term'));},contentChange:function(){this._highlight(this.scope.attr('data-term'));},_highlight:function(term){var terms=term.split(" ");var elements=this.scope.find('.cSearchResultHighlight *:icontains("'+term+'")');$.each(terms,function(index,term){elements.contents().filter(function(){return this.nodeType===3}).each(function(){$(this).replaceWith(_.escape($(this).text().replace(new RegExp("("+term+")","i"),'<mark class="ipsMatch'+(index+1)+'">'+"$1 "+'</mark>')).replace("&lt;mark class=&quot;ipsMatch"+(index+1)+"&quot;&gt;","<mark class='ipsMatch"+(index+1)+"'>").replace("&lt;/mark&gt;","</mark>"));});});}});}(jQuery,_));;